<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Uncertainty Calculator</title>
  <style>
    body { font-family: Arial; max-width: 700px; margin: auto; }
    input { margin: 4px; }
    .var-block { margin-bottom: 8px; }
    pre { background: #f4f4f4; padding: 10px; }
  </style>
</head>

<body>
  <h1>Uncertainty Calculator</h1>

  <label>Expression:</label><br>
  <input id="expression" placeholder="e.g. x*y + z" size="40">
  <button onclick="generateInputs()">Set Variables</button>

  <div id="variables"></div>

  <button onclick="calculate()">Calculate</button>

  <h3>Result</h3>
  <pre id="output"></pre>

<script>
function extractVariables(expr) {
  const knownFunctions = [
    "sin", "cos", "tan",
    "asin", "acos", "atan",
    "log", "ln", "sqrt", "exp"
  ];

  const matches = expr.match(/[a-zA-Z]+/g) || [];

  return [...new Set(
    matches.filter(v => !knownFunctions.includes(v))
  )];
}


function generateInputs() {
  const expr = document.getElementById("expression").value.trim();
  if (!expr) {
    alert("Enter an expression first.");
    return;
  }

  const vars = extractVariables(expr);
  const container = document.getElementById("variables");
  container.innerHTML = "";

  vars.forEach(v => {
    container.innerHTML += `
      <div class="var-block">
        <strong>${v}</strong><br>
        value: <input id="${v}_value" type="number" step="any">
        uncertainty: <input id="${v}_unc" type="number" step="any">
      </div>
    `;
  });
}

async function calculate() {
  console.log("CALCULATE CLICKED");
  const expr = document.getElementById("expression").value.trim();
  if (!expr) {
    alert("Expression is empty.");
    return;
  }

  const vars = extractVariables(expr);
  let payload = { expression: expr, variables: {} };

  for (const v of vars) {
    const valueInput = document.getElementById(`${v}_value`);
    const uncInput = document.getElementById(`${v}_unc`);

    if (!valueInput || !uncInput) {
      alert("Click 'Set Variables' AFTER entering the final expression.");
      return;
    }

    payload.variables[v] = {
      value: parseFloat(valueInput.value),
      uncertainty: parseFloat(uncInput.value)
    };
  }

  try {
    console.log("POSTING TO /calculate");
    const res = await fetch(
      "https://uncertainty-calculator.onrender.com/calculate",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      }
    );

    const text = await res.text();
    document.getElementById("output").textContent = text;

  } catch (err) {
    console.error(err);
    alert("Failed to contact backend.");
  }
}
</script>

</body>
</html>
